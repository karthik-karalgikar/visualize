<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Visualizer</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const Play = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
        const SkipBack = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg>;
        const SkipForward = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>;
        const AlertCircle = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;

        const renderFormula = (formulaObj) => {
          if (!formulaObj) return null;
          const { latex, expr } = formulaObj;
          if (latex && window.katex) {
            try {
              const html = window.katex.renderToString(latex, { throwOnError: false, displayMode: true });
              return <div dangerouslySetInnerHTML={{ __html: html }} className="mb-2" />;
            } catch (e) {
              return <pre className="text-xs text-white">{latex || expr}</pre>;
            }
          } else {
            return <pre className="text-xs text-white">{expr}</pre>;
          }
        };

        // Enhanced visualization components
        const ArrayVisualization = ({ arr, name }) => {
          return (
            <div className="space-y-2">
              <div className="flex items-center gap-2 flex-wrap">
                <span className="text-xs text-gray-500">indices:</span>
                {arr.slice(0, 20).map((_, idx) => (
                  <div key={idx} className="w-12 text-center text-xs text-gray-400">
                    {idx}
                  </div>
                ))}
                {arr.length > 20 && <span className="text-xs text-gray-500">...</span>}
              </div>
              <div className="flex items-center gap-2 flex-wrap">
                {arr.slice(0, 20).map((item, idx) => (
                  <div 
                    key={idx}
                    className="relative group"
                  >
                    <div className="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 border-2 border-blue-700 rounded flex items-center justify-center text-white font-bold shadow-lg transform transition-transform hover:scale-110">
                      {typeof item === 'number' ? item.toFixed(1) : JSON.stringify(item)}
                    </div>
                    <div className="absolute -bottom-6 left-0 right-0 text-center text-xs text-blue-300 opacity-0 group-hover:opacity-100 transition-opacity">
                      [{idx}]
                    </div>
                  </div>
                ))}
                {arr.length > 20 && (
                  <div className="text-gray-400 text-sm">... +{arr.length - 20} more</div>
                )}
              </div>
            </div>
          );
        };

        const DictVisualization = ({ dict }) => {
          return (
            <div className="space-y-2">
              {Object.entries(dict).map(([key, value], idx) => (
                <div key={idx} className="flex items-center gap-3 bg-purple-900/30 p-3 rounded-lg border border-purple-500/50">
                  <div className="bg-purple-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">
                    {key}
                  </div>
                  <div className="text-purple-300">‚Üí</div>
                  <div className="bg-purple-800/50 text-purple-200 px-3 py-1 rounded font-mono text-sm flex-1">
                    {JSON.stringify(value)}
                  </div>
                </div>
              ))}
            </div>
          );
        };

        const MatrixVisualization = ({ matrix, name }) => {
          // Check if it's a numpy array from backend
          if (matrix && matrix.type === 'ndarray') {
            const values = matrix.values;
            
            // If values is a 2D array, display as matrix
            if (Array.isArray(values) && Array.isArray(values[0])) {
              const rows = values.length;
              const cols = values[0].length;
              
              return (
                <div className="space-y-2">
                  <div className="text-xs text-gray-400 mb-2">
                    numpy array: {rows} √ó {cols}
                  </div>
                  <div className="inline-block border-2 border-green-500 rounded">
                    {values.map((row, i) => (
                      <div key={i} className="flex">
                        {row.map((val, j) => (
                          <div 
                            key={j}
                            className="w-16 h-16 border border-green-700/30 bg-green-900/20 flex items-center justify-center text-green-300 font-mono text-xs"
                          >
                            {typeof val === 'number' ? val.toFixed(2) : JSON.stringify(val)}
                          </div>
                        ))}
                      </div>
                    ))}
                  </div>
                </div>
              );
            }
            
            // If values is a 1D array, display as array visualization
            if (Array.isArray(values)) {
              return <ArrayVisualization arr={values} name={name} />;
            }
            
            // If we have summary (large array), show summary
            if (matrix.summary) {
              return (
                <div className="space-y-2">
                  <div className="text-xs text-yellow-400 mb-2">
                    Large numpy array (size: {matrix.summary.size})
                  </div>
                  <div className="bg-slate-700 p-3 rounded text-sm text-gray-300">
                    <div>Min: {matrix.summary.min?.toFixed(4)}</div>
                    <div>Max: {matrix.summary.max?.toFixed(4)}</div>
                    <div>Mean: {matrix.summary.mean?.toFixed(4)}</div>
                    <div className="mt-2">Sample: {JSON.stringify(matrix.summary.sample)}</div>
                  </div>
                </div>
              );
            }
          }

          // Check if it's a regular 2D array
          if (Array.isArray(matrix) && Array.isArray(matrix[0])) {
            const rows = matrix.length;
            const cols = matrix[0].length;

            return (
              <div className="space-y-2">
                <div className="text-xs text-gray-400 mb-2">
                  list: {rows} √ó {cols}
                </div>
                <div className="inline-block border-2 border-green-500 rounded">
                  {matrix.map((row, i) => (
                    <div key={i} className="flex">
                      {row.map((val, j) => (
                        <div 
                          key={j}
                          className="w-16 h-16 border border-green-700/30 bg-green-900/20 flex items-center justify-center text-green-300 font-mono text-xs"
                        >
                          {typeof val === 'number' ? val.toFixed(2) : JSON.stringify(val)}
                        </div>
                      ))}
                    </div>
                  ))}
                </div>
              </div>
            );
          }

          return <span className="font-mono text-orange-700">{JSON.stringify(matrix)}</span>;
        };

        const PythonVisualizer = () => {
          const [code, setCode] = useState(`# Try different examples!
import numpy as np

# Arrays
list1 = [1, 2, 3]

# NumPy arrays
x = np.array([[1.0, 2.0], [3.0, 4.0]])
w = np.random.randn(2, 3)

# Operations
y = x * 0.5
z = w + 10`);
          const [executionLog, setExecutionLog] = useState([]);
          const [currentStep, setCurrentStep] = useState(0);
          const [isRunning, setIsRunning] = useState(false);
          const [error, setError] = useState(null);
          const [autoPlay, setAutoPlay] = useState(false);

          const currentStepData = executionLog[currentStep];
          const locals = (currentStepData && (currentStepData.after || currentStepData.before)) || {};

          // Auto-play functionality
          useEffect(() => {
            if (autoPlay && currentStep < executionLog.length - 1) {
              const timer = setTimeout(() => {
                setCurrentStep(prev => prev + 1);
              }, 1000);
              return () => clearTimeout(timer);
            } else if (autoPlay && currentStep === executionLog.length - 1) {
              setAutoPlay(false);
            }
          }, [autoPlay, currentStep, executionLog.length]);

          const changedVars = (() => {
            if (!currentStepData || currentStep === 0) return new Set();
            const prev = executionLog[currentStep - 1]?.after || executionLog[currentStep - 1]?.before || {};
            const curr = currentStepData?.after || currentStepData?.before || {};
            const changed = new Set();
            Object.keys(curr).forEach(key => {
              if (JSON.stringify(prev[key]) !== JSON.stringify(curr[key]))
                changed.add(key);
            });
            return changed;
          })();

          const runCode = async () => {
            setIsRunning(true);
            setError(null);
            setCurrentStep(0);
            setAutoPlay(false);
            
            try {
              const response = await fetch('http://127.0.0.1:5000/execute', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ code }),
              });

              const data = await response.json();
              
              if (data.success) {
                setExecutionLog(data.steps);
              } else {
                setError(data.error);
              }
            } catch (err) {
              setError('Failed to connect to backend. Make sure Flask server is running on port 5000.');
              console.error('Error:', err);
            }
            
            setIsRunning(false);
          };

          const detectType = (value) => {
            if (!value || typeof value !== 'object') {
              if (typeof value === 'string') return 'string';
              if (typeof value === 'number') return 'number';
              return 'other';
            }
            
            // FIXED: Check for numpy array first (before checking for dict)
            if (value.type === 'ndarray') return 'ndarray';
            if (value.__torch_tensor__) return 'tensor';
            
            // Check for regular arrays
            if (Array.isArray(value)) {
              if (value.length > 0 && Array.isArray(value[0])) return 'matrix';
              return 'array';
            }
            
            // If it's a plain object (dict)
            if (typeof value === 'object' && value !== null) return 'dict';
            
            return 'other';
          };

          const renderValue = (value, name) => {
            const type = detectType(value);

            switch (type) {
              case 'array':
                return <ArrayVisualization arr={value} name={name} />;
              case 'ndarray':
                return <MatrixVisualization matrix={value} name={name} />;
              case 'tensor':
                return <MatrixVisualization matrix={value} name={name} />;
              case 'dict':
                return <DictVisualization dict={value} />;
              case 'matrix':
                return <MatrixVisualization matrix={value} name={name} />;
              case 'string':
                return <span className="font-mono text-green-400 text-lg">"{value}"</span>;
              case 'number':
                return <span className="font-mono text-orange-400 text-xl font-bold">{value}</span>;
              default:
                return <span className="font-mono text-gray-400">{JSON.stringify(value)}</span>;
            }
          };

          const codeLines = code.split('\n');

          return (
            <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4">
              <div className="max-w-[1800px] mx-auto">
                <div className="text-center mb-6">
                  <h1 className="text-4xl font-bold text-white mb-2">
                    Python Execution Visualizer v2
                  </h1>
                  <p className="text-purple-200">Enhanced with NumPy support</p>
                </div>

                <div className="grid grid-cols-1 xl:grid-cols-3 gap-4 mb-4">
                  {/* Code Editor */}
                  <div className="xl:col-span-1 bg-slate-800 rounded-xl shadow-2xl p-4 border border-slate-700">
                    <div className="flex justify-between items-center mb-3">
                      <h2 className="text-lg font-semibold text-white">Code Editor</h2>
                      <div className="text-xs text-purple-300">Python 3 + NumPy</div>
                    </div>
                    <textarea
                      value={code}
                      onChange={(e) => setCode(e.target.value)}
                      className="w-full h-96 font-mono text-sm p-3 bg-slate-900 text-green-400 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                      placeholder="Enter your Python code here..."
                      spellCheck="false"
                    />
                    <button
                      onClick={runCode}
                      disabled={isRunning}
                      className="mt-3 w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 disabled:from-gray-600 disabled:to-gray-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition shadow-lg"
                    >
                      <Play />
                      {isRunning ? 'Executing...' : 'Run & Visualize'}
                    </button>
                    
                    {error && (
                      <div className="mt-3 bg-red-900/50 border border-red-500 text-red-200 p-3 rounded-lg flex items-start gap-2 text-xs">
                        <AlertCircle />
                        <div>
                          <div className="font-semibold mb-1">Error:</div>
                          <pre className="whitespace-pre-wrap font-mono">{error}</pre>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Visual Canvas */}
                  <div className="xl:col-span-2 bg-slate-800 rounded-xl shadow-2xl p-4 border border-slate-700">
                    <h2 className="text-lg font-semibold text-white mb-3">
                      Visual Canvas
                    </h2>
                    
                    {executionLog.length === 0 ? (
                      <div className="text-slate-400 text-center py-32">
                        <div className="text-6xl mb-4 opacity-50">üé®</div>
                        <p className="text-lg">Run your code to see visualizations</p>
                        <p className="text-sm mt-2">Lists, NumPy arrays, and matrices will be visualized</p>
                      </div>
                    ) : (
                      <div className="space-y-4 max-h-[500px] overflow-y-auto p-4 bg-slate-900/50 rounded-lg">
                        {/* Show formula if current line has one */}
                        {currentStepData?.formula && (
                          <div className="bg-indigo-900/30 border-2 border-indigo-500 rounded-xl p-4 mb-4">
                            <div className="text-xs text-indigo-400 mb-2 font-semibold">
                               Formula at Line {currentStepData.lineno}
                            </div>
                            <div className="bg-slate-900 p-4 rounded-lg">
                              {renderFormula(currentStepData.formula)}
                            </div>
                          </div>
                        )}
                        {Object.keys(locals).length > 0 ? (
                          Object.entries(locals).map(([name, value]) => (
                            <div 
                              key={name} 
                              className={`rounded-xl p-4 border-2 transition-all ${
                                changedVars.has(name)
                                  ? 'bg-yellow-900/20 border-yellow-500 shadow-xl shadow-yellow-500/30'
                                  : 'bg-slate-800/80 border-slate-600'
                              }`}
                            >
                              <div className="flex items-center gap-3 mb-4">
                                <span className="font-mono text-lg font-bold text-blue-400">
                                  {name}
                                </span>
                                <span className="text-xs bg-slate-700 text-slate-300 px-2 py-1 rounded">
                                  {detectType(value)}
                                </span>
                                {changedVars.has(name) && (
                                  <span className="text-xs bg-yellow-500 text-black px-2 py-1 rounded-full font-bold">
                                    CHANGED
                                  </span>
                                )}
                              </div>
                              <div className="pl-2">
                                {renderValue(value, name)}
                              </div>
                            </div>
                          ))
                        ) : (
                          <div className="text-slate-400 text-center py-16">
                            No variables defined yet
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>

                {/* Controls and Code Display */}
                {executionLog.length > 0 && (
                  <div className="bg-slate-800 rounded-xl shadow-2xl p-4 border border-slate-700">
                    <div className="flex items-center justify-between mb-4 pb-3 border-b border-slate-700">
                      <div className="flex gap-2">
                        <button
                          onClick={() => setCurrentStep(0)}
                          disabled={currentStep === 0}
                          className="px-3 py-1 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:text-slate-600 text-white rounded text-sm"
                        >
                          Reset
                        </button>
                        <button
                          onClick={() => setAutoPlay(!autoPlay)}
                          className={`px-3 py-1 rounded text-sm ${
                            autoPlay 
                              ? 'bg-red-600 hover:bg-red-700 text-white' 
                              : 'bg-green-600 hover:bg-green-700 text-white'
                          }`}
                        >
                          {autoPlay ? 'Pause' : 'Auto Play'}
                        </button>
                      </div>
                      
                      <div className="flex items-center gap-3">
                        <button
                          onClick={() => setCurrentStep(Math.max(0, currentStep - 1))}
                          disabled={currentStep === 0}
                          className="p-2 bg-purple-600 hover:bg-purple-700 disabled:bg-slate-700 disabled:text-slate-500 text-white rounded shadow-lg"
                        >
                          <SkipBack />
                        </button>
                        
                        <div className="text-center">
                          <div className="text-xl font-bold text-white">
                            {currentStep + 1} / {executionLog.length}
                          </div>
                          <div className="text-xs text-purple-300">Step</div>
                        </div>
                        
                        <button
                          onClick={() => setCurrentStep(Math.min(executionLog.length - 1, currentStep + 1))}
                          disabled={currentStep === executionLog.length - 1}
                          className="p-2 bg-purple-600 hover:bg-purple-700 disabled:bg-slate-700 disabled:text-slate-500 text-white rounded shadow-lg"
                        >
                          <SkipForward />
                        </button>
                      </div>

                      <div className="w-24"></div>
                    </div>

                    {currentStepData && (
                      <div className="mb-4 bg-yellow-500/10 border-l-4 border-yellow-500 p-3 rounded">
                        <div className="text-xs text-yellow-400 mb-1 font-semibold">
                          {currentStepData.event === "call" && `CALL ‚Üí ${currentStepData.func}()`}
                          {currentStepData.event === "return" && `RETURN ‚Üê ${currentStepData.func}()`}
                          {currentStepData.event === "line" && `Line ${currentStepData.lineno}`}
                        </div>
                        {currentStepData.code && (
                          <code className="text-sm font-mono text-white">{currentStepData.code}</code>
                        )}
                        {currentStepData.formula && (
                          <div className="mt-3">
                            {renderFormula(currentStepData.formula)}
                          </div>
                        )}
                      </div>
                    )}

                    <div className="bg-slate-900 rounded-lg p-3 font-mono text-xs overflow-x-auto">
                      {codeLines.map((line, idx) => {
                        const lineNo = idx + 1;
                        const isCurrentLine = currentStepData && currentStepData.lineno === lineNo;
                        const isExecuted = executionLog.some((step, stepIdx) => 
                          step.lineno === lineNo && stepIdx <= currentStep
                        );
                        
                        return (
                          <div
                            key={idx}
                            className={`px-2 py-1 transition-all ${
                              isCurrentLine
                                ? 'bg-yellow-500 text-slate-900 font-bold'
                                : isExecuted
                                ? 'bg-green-900/30 text-green-300'
                                : 'text-slate-500'
                            }`}
                          >
                            <span className="text-slate-600 mr-3 select-none inline-block w-6 text-right">
                              {lineNo}
                            </span>
                            {line || ' '}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        };

        ReactDOM.render(<PythonVisualizer />, document.getElementById('root'));
    </script>
</body>
</html>